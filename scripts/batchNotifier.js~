var csv = require('fast-csv');
var fs = require('fs');
var config = require('../resources/config');
var client = require('twilio')(config.accountSid, config.authToken);

module.exports = {
    run: function(path){
	if(path == 'alert'){
		var stream = fs.createReadStream(config.alerts);
	}else{
		var stream = fs.createReadStream(config.missed);
	}

	csv
	.fromStream(stream, {headers : ["Name", "Phone", "Case", "Date", "Time", "Location"]})
	.on("data", function(data){
		if(path == 'alert'){
			var body = data.Name + ', You have a hearing for case ' + data.Case + ' at ' + data.Location + ' on ' + data.Date + ' at ' + data.Time
		}else{
			var body = data.Name + ', You missed your hearing for case ' + data.Case + ' at ' + data.Location + '. Please call the court at your earliest availability.'
		}		
		var options = {
			to: data.Phone,
			from: config.twilioNumber,
			body: body
		}

		client.sendMessage(options, function(err, res){
			if(err){
				console.log(err);
				res.json({

				});
			}else{
				var masked = data.Phone.substr(5, to.length);
            			console.log('Message Sent To ' + masked);
			}
		});
	})
	.on("end", function(){
		console.log(path + ' batch executed');
	});
    }
}
